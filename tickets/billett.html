<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billett – Larvik Rockeklubb</title>

<!-- PDF & QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
@font-face {
  font-family:'BurnabyStencil';
  src:url('Burnaby_Stencil.woff') format('woff');
  font-display:swap;
}
*{box-sizing:border-box;scroll-behavior:smooth;}
body{
  margin:0;
  font-family:Helvetica,Arial,sans-serif;
  background:#111;
  color:#eee;
  overflow-x:hidden;
}

/* --- HEADER --- */
header{
  background:#1a1a1a;
  padding:8px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:2px solid #e63946;
  position:relative;
}
header img{max-height:90px;}
.logo-left{max-height:90px;}
.logo-center{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:30px;
  max-height:45px;
}

/* --- MENY --- */
nav a{
  color:#eee;
  text-decoration:none;
  border:1px solid #e63946;
  padding:8px 15px;
  border-radius:6px;
  transition:0.3s;
}
nav a:hover{
  background:#e63946;
  color:#111;
}

/* --- STATUS --- */
#statusBox{
  max-width:840px;
  margin:60px auto 10px auto;
  padding:15px;
  border-radius:8px;
  font-size:1.1rem;
  text-align:center;
  color:#fff;
  display:none;
}
.ok{background:#28a745;}
.fail{background:#dc3545;}

/* --- ACTION KNAPPER --- */
.actions{
  max-width:840px;
  margin:10px auto;
  text-align:center;
}

/* === FELLES KNAPPEDESIGN === */
button, .btn-standard, .utleie-btn, a.knapp, input[type="submit"] {
  display: inline-block;
  text-align: center;
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #fff;
  background: linear-gradient(180deg, #2a2a2a 0%, #101010 100%);
  border: 1px solid #000;
  border-radius: 8px;
  padding: 10px 25px;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow:
    0 3px 6px rgba(0,0,0,0.7),
    inset 0 1px 0 rgba(255,255,255,0.12);
}
button:hover, .btn-standard:hover, .utleie-btn:hover, a.knapp:hover, input[type="submit"]:hover {
  color: #f5f5f5;
  background: linear-gradient(180deg, #343434 0%, #151515 100%);
  box-shadow:
    0 4px 8px rgba(0,0,0,0.9),
    0 0 10px rgba(255,255,255,0.25),
    0 0 12px rgba(255,255,255,0.25),
    inset 0 1px 1px rgba(255,255,255,0.15);
  transform: translateY(-2px);
}
button:active, .btn-standard:active, .utleie-btn:active, a.knapp:active, input[type="submit"]:active {
  background: linear-gradient(180deg, #1a1a1a 0%, #050505 100%);
  box-shadow:
    inset 0 2px 4px rgba(0,0,0,0.8),
    inset 0 -1px 0 rgba(255,255,255,0.1),
    0 0 5px rgba(230,57,70,0.5);
  transform: translateY(1px);
}

/* --- BILLETT --- */
.billett{
  position:relative;
  width:700px;
  height:230px;
  margin:50px auto;
  background:url('billett.png') no-repeat center/cover;
  border:2px solid #111;
  box-shadow:0 0 20px rgba(230,57,70,0.5);
}
.text {
  position: absolute;
  white-space: nowrap;
  color: #000;
  font-size: 12px;
  top: 12px;
  left: auto;
  right: 16px;
}

.midt{
  font-family:'BurnabyStencil',Helvetica,Arial,sans-serif;
  text-align:center;
  position:absolute;
  left:50%;
  transform:translate(-50%,-50%);
}
.midt.bottomfix {
  position: absolute;
  left: 50%;
  bottom: 12px;
  transform: translateX(-50%);
  font-family: Helvetica, Arial, sans-serif !important;
  font-size: 12px !important;
  text-align: center;
  color: #000;
  width: 100%;
}
.qr{ position:absolute; width:120px; height:120px; }
.qr img{pointer-events:none;}

/* --- FOOTER --- */
footer{
  text-align:center;
  padding:15px;
  border-top:2px solid #e63946;
  color:#aaa;
  background:#1a1a1a;
  margin-top:40px;
}

</style>

</head>
<body>

<header>
  <img src="logo_vekter.png" alt="Larvik Rockeklubb Logo" class="logo-left">
  <img src="logo_midt.png" alt="Larvik Rockeklubb midtlogo" class="logo-center">
  <nav><a href="index.html">Hjem</a></nav>
</header>

<main>
  <div id="statusBox"></div>
  <div id="billetter"></div>
  <div class="actions" id="actions" style="display:none;">
    <button id="pdfBtn">⬇️ Last ned PDF</button>
  </div>
</main>

<footer>
  &copy; 2025 Larvik Rockeklubb. Alle rettigheter forbeholdt.
</footer>

<script>
const p = new URLSearchParams(location.search);
const status = p.get('status') || 'ok';
const band = p.get('band') || 'BAND';
const tour = p.get('tour') || 'TOURNAVN';
const venue = p.get('venue') || 'STED';
const date = p.get('date') || '10. mai';
const time = p.get('time') || '20:00';
const price = p.get('price') || '450';
const name = p.get('name') || 'Navn Navnesen';
const arrid = p.get('arrid') || 'LRK2025-0001';
const qty = Math.max(1, parseInt(p.get('qty') || '1', 10));
const order = Math.floor(100000 + Math.random() * 900000);
const today = new Date().toLocaleDateString('no-NO');
const container = document.getElementById('billetter');
const base = Math.floor(Math.random() * 9000 + 1000);

const statusBox = document.getElementById('statusBox');
const actions = document.getElementById('actions');

if (status === 'ok') {
  statusBox.classList.add('ok');
  statusBox.innerHTML = '✅ Betaling fullført!<br>Billettene er sendt til din e-postadresse.<br>Du kan også laste ned billettene nedenfor.';
  statusBox.style.display = 'block';
  actions.style.display = 'block';
} else {
  statusBox.classList.add('fail');
  statusBox.innerHTML = '❌ Betalingen ble ikke fullført.<br>Ingen penger er trukket – prøv igjen.';
  statusBox.style.display = 'block';
}

/* --- Tegn billett(er) --- */
if (status === 'ok') {
  for (let i = 0; i < qty; i++) {
    const nr = `LRK-${base + i}`;
    const b = document.createElement('div');
    b.className = 'billett';
    b.id = `billett-${i}`;
    b.innerHTML = `
      <div class="text ordrenr" id="ordrenr-${i}"><b>Ordrenr:</b> ${order}</div>
      <div class="text navn" id="navn-${i}"><b>Navn:</b> ${name}</div>
      <div class="text pris" id="pris-${i}"><b>Pris:</b> Kr. ${price},-</div>
      <div class="text kjopsdato" id="kjopsdato-${i}"><b>Kjøpsdato:</b> ${today}</div>

      <div class="text midt band" id="band-${i}">${band}</div>
      <div class="text midt tour" id="tour-${i}">${tour}</div>
      <div class="text midt venue" id="venue-${i}">${venue}</div>
      <div class="text midt date" id="date-${i}">${date} – Kl. ${time}</div>
      <div class="text midt reftext bottomfix" id="reftext-${i}" style="font-size:12px;">Kjøpt billett refunderes ikke.</div>

      <div class="text eventid" id="eventid-${i}">Event-ID: ${arrid}-${i+1}</div>
      <div class="text site" id="site-${i}">www.larvik-rockeklubb.no</div>
      <div class="qr" id="qr-${i}"></div>
    `;
    container.appendChild(b);

    new QRCode(document.getElementById(`qr-${i}`), {
      text: `Larvik Rockeklubb | ${band} | ${tour} | ${venue} | ${date} ${time} | ${name} | ${nr} | ArrID:${arrid}-${i+1}`,
      width: 120,
      height: 120
    });
  }

  /* --- Hent layout fra JSON --- */
  setTimeout(() => {
    fetch("billett_layout.json")
      .then(r => r.ok ? r.json() : null)
      .then(layout => {
        if (!layout) return;
        for (const id in layout) {
          const baseId = id.replace(/-\d+$/, "");
          const d = layout[id];
          const elements = document.querySelectorAll(`[id^="${baseId}-"]`);
          elements.forEach(el => {
            if (d.top) el.style.top = d.top.toString().includes("px") ? d.top : d.top + "px";
            if (d.left) el.style.left = d.left.toString().includes("px") ? d.left : d.left + "px";
            if (d.right) el.style.right = d.right.toString().includes("px") ? d.right : d.right + "px";
            if (d.bottom) el.style.bottom = d.bottom.toString().includes("px") ? d.bottom : d.bottom + "px";
            if (d.fontSize) el.style.fontSize = d.fontSize;
          });
        }
      });
  }, 200);

 /* --- PDF nedlasting: KUN ved klikk på knappen --- */
document.getElementById("pdfBtn").addEventListener("click", async function () {
  // vis spinner først NÅ (kun ved klikk)
  var overlay  = document.getElementById("loadingOverlay");
  var progress = document.getElementById("progressText");
  if (overlay) {
    overlay.style.display = "flex";
    if (progress) progress.textContent = "Genererer PDF ... 0 %";
  }

  try {
    var billets = document.querySelectorAll(".billett");
    if (!billets.length) {
      if (overlay) overlay.style.display = "none";
      alert("Fant ingen billetter å generere ennå.");
      return;
    }

    var jsPDF = window.jspdf.jsPDF;
    var pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

    // PDF-layout
    var billettH = 60;   // brukes kun til sidebryting
    var marginX  = 15;
    var marginY  = 20;
    var spacingY = 15;

    var pageH = pdf.internal.pageSize.getHeight();
    var y = marginY;
    var total = billets.length;

    for (var i = 0; i < total; i++) {
      var ticket = billets[i];

      // ny side ved behov
      if (y + billettH > pageH - marginY) {
        pdf.addPage();
        y = marginY;
      }

      // render akkurat nåværende DOM-billett (høy oppløsning)
      var canvas = await html2canvas(ticket, {
        scale: 5,
        useCORS: true,
        backgroundColor: "#ffffff",
        scrollY: 0,
        windowWidth:  ticket.scrollWidth,
        windowHeight: ticket.scrollHeight
      });

      var img = canvas.toDataURL("image/png", 1.0);

      // fra canvas-px til mm (≈400 dpi ved scale:5)
      var imgWidthMm  = (canvas.width  * 25.4) / 400.0;
      var imgHeightMm = (canvas.height * 25.4) / 400.0;

      // litt smalere for luft på høyre side
      var scale = 0.81;
      pdf.addImage(img, "PNG", marginX, y, imgWidthMm * scale, imgHeightMm * scale, undefined, "SLOW");

      y += billettH + spacingY;

      // fremdrift
      if (progress) {
        var pct = Math.round(((i + 1) / total) * 100);
        progress.textContent = "Genererer PDF ... " + pct + " %";
      }
    }

    pdf.save(band + "_billetter.pdf");
    if (progress) progress.textContent = "Ferdig!";
  } catch (err) {
    console.error("Feil under PDF-generering:", err);
    alert("Kunne ikke generere PDF. Sjekk konsollen for detaljer.");
  } finally {
    if (overlay) {
      setTimeout(function(){ overlay.style.display = "none"; }, 1000);
    }
  }
});
}
</script>
</body>
</html>
